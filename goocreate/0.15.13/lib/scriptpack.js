goo.AxisAlignedCamControlScript=function(t,e,n){"use strict";function o(){function e(e,i){i.axis=t.UNIT_Z.clone(),i.upAxis=t.UNIT_Y.clone(),o(e,i,e.view),i.currentView=e.view,i.lookAtPoint=new t,i.distance=e.distance,i.smoothness=Math.pow(n.clamp(e.smoothness,0,1),.3),i.axisAlignedDirty=!0}function o(e,n,o){if(n.currentView!==o){switch(n.currentView=o,o){case"XY":n.axis.set(t.UNIT_Z),n.upAxis.set(t.UNIT_Y);break;case"ZY":n.axis.set(t.UNIT_X),n.upAxis.set(t.UNIT_Y)}n.axisAlignedDirty=!0}}function i(t,e){if(t.view!==e.currentView&&(e.axisAlignedDirty=!0),e.axisAlignedDirty){var n=e.entity,o=n.transformComponent.transform;o.translation.set(e.axis).scale(e.distance).add(e.lookAtPoint),o.lookAt(e.lookAtPoint,e.upAxis),n.transformComponent.setUpdated(),e.axisAlignedDirty=!1}}function r(){}return{setup:e,update:i,cleanup:r}}return o.externals={key:"AxisAlignedCamControlScript",name:"Axis-aligned Camera Control",description:"Aligns a camera along an axis, and enables switching between them.",parameters:[{key:"whenUsed",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0,type:"boolean"},{key:"distance",name:"Distance",type:"float",description:"Camera distance from lookat point",control:"slider","default":1,min:1,max:1e3},{key:"view",type:"string","default":"XY",control:"select",options:["XY","ZY"]}]},o}(goo.Vector3,goo.ScriptUtils,goo.MathUtils),goo.BasicControlScript=function(t,e){"use strict";function n(n){n=n||{},this.domElement=void 0===n.domElement?null:n.domElement.domElement||n.domElement,this.name="BasicControlScript",this.movementSpeed=10,this.rollSpeed=2,this.movementSpeedMultiplier=1,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new t(0,0,0),this.rotationVector=new t(0,0,0),this.multiplier=new t(1,1,1),this.rotationMatrix=new e,this.tmpVec=new t,this.handleEvent=function(t){"function"==typeof this[t.type]&&this[t.type](t)},this.keydown=function(t){if(!t.altKey){switch(t.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()}},this.keyup=function(t){switch(t.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(t){this.domElement!==document&&this.domElement.focus(),t.preventDefault(),t=t.touches&&1===t.touches.length?t.touches[0]:t,this.mouseDownX=t.pageX,this.mouseDownY=t.pageY,this.mouseStatus=1,document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),document.addEventListener("touchmove",this.mousemove,!1),document.addEventListener("touchend",this.mouseup,!1)}.bind(this),this.mousemove=function(t){this.mouseStatus>0&&(t=t.touches&&1===t.touches.length?t.touches[0]:t,this.moveState.yawLeft=t.pageX-this.mouseDownX,this.moveState.pitchDown=t.pageY-this.mouseDownY,this.updateRotationVector(),this.mouseDownX=t.pageX,this.mouseDownY=t.pageY)}.bind(this),this.mouseup=function(t){this.mouseStatus&&(t.preventDefault(),this.mouseStatus=0,this.moveState.yawLeft=this.moveState.pitchDown=0,this.updateRotationVector(),document.removeEventListener("mousemove",this.mousemove),document.removeEventListener("mouseup",this.mouseup),document.removeEventListener("touchmove",this.mousemove),document.removeEventListener("touchend",this.mouseup))}.bind(this),this.updateMovementVector=function(){var t=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-t+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!==document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement&&this.setupMouseControls(),this.updateMovementVector(),this.updateRotationVector()}return n.prototype.setupMouseControls=function(){this.domElement.setAttribute("tabindex",-1),this.domElement.addEventListener("mousedown",this.mousedown,!1),this.domElement.addEventListener("touchstart",this.mousedown,!1),this.domElement.addEventListener("keydown",this.keydown.bind(this),!1),this.domElement.addEventListener("keyup",this.keyup.bind(this),!1)},n.prototype.externals=function(){return[{variable:"movementSpeed",type:"number"},{variable:"rollSpeed",type:"number"}]},n.prototype.run=function(e,n,o){o&&!this.domElement&&o.domElement&&(this.domElement=o.domElement,this.setupMouseControls());var i=e.transformComponent,r=i.transform,a=e._world.tpf,s=a*this.movementSpeed*this.movementSpeedMultiplier,c=a*this.rollSpeed*this.movementSpeedMultiplier;(!this.moveVector.equals(t.ZERO)||!this.rotationVector.equals(t.ZERO)||this.mouseStatus>0)&&(r.translation.x+=this.moveVector.x*s,r.translation.y+=this.moveVector.y*s,r.translation.z+=this.moveVector.z*s,this.tmpVec.x+=-this.rotationVector.x*c*this.multiplier.x,this.tmpVec.y+=this.rotationVector.y*c*this.multiplier.y,this.tmpVec.z+=this.rotationVector.z*c*this.multiplier.z,r.rotation.fromAngles(this.tmpVec.x,this.tmpVec.y,this.tmpVec.z),this.mouseStatus>0&&(this.moveState.yawLeft=0,this.moveState.pitchDown=0,this.updateRotationVector()),i.setUpdated())},n}(goo.Vector3,goo.Matrix3),goo.ButtonScript=function(t,e,n,o,i){"use strict";function r(){function t(t,n){n.button=["Any","Left","Middle","Right"].indexOf(t.button)-1,n.button<-1&&(n.button=-1),n.renderToPickHandler=function(){n.skipUpdateBuffer=!0},i.addListener("ButtonScript.renderToPick",n.renderToPickHandler,!1),n.mouseState={x:0,y:0,down:!1,downOnEntity:!1,overEntity:!1},n.listeners={mousedown:function(o){if(t.whenUsed){var i=r(o);(i===n.button||-1===n.button)&&(n.mouseState.down=!0,e(t,n,o),a(t,n,"mousedown"))}},mouseup:function(o){if(t.whenUsed){var i=r(o);(i===n.button||-1===n.button)&&(n.mouseState.down=!1,e(t,n,o),n.mouseState.downOnEntity&&a(t,n,"click"),a(t,n,"mouseup"))}},dblclick:function(o){if(t.whenUsed){var i=r(o);(i===n.button||-1===n.button)&&(n.mouseState.down=!1,e(t,n,o),a(t,n,"dblclick"))}},mousemove:function(o){t.whenUsed&&t.enableOnMouseMove&&(n.mouseState.down=!1,e(t,n,o),a(t,n,"mousemove"))},touchstart:function(e){if(t.whenUsed){n.mouseState.down=!0;var o=e.targetTouches,i=n.domElement.getBoundingClientRect();n.mouseState.x=o[0].pageX-i.left,n.mouseState.y=o[0].pageY-i.top,a(t,n,"touchstart")}},touchend:function(){t.whenUsed&&(n.mouseState.down=!1,a(t,n,"touchend"))}};for(var o in n.listeners)n.domElement.addEventListener(o,n.listeners[o])}function e(t,e,n){var o=e.domElement.getBoundingClientRect();e.mouseState.x=n.pageX-o.left,e.mouseState.y=n.pageY-o.top}function n(t,e){e.skipUpdateBuffer=!1}function o(t,e){for(var n in e.listeners)e.domElement.removeEventListener(n,e.listeners[n]);i.removeListener("ButtonScript.renderToPick",e.renderToPickHandler)}function r(t){var e=t.button;return 0===e&&(t.altKey?e=2:t.shiftKey&&(e=1)),e}function a(t,e,n){var o=e.entity._world.gooRunner,r=o.pickSync(e.mouseState.x,e.mouseState.y,e.skipUpdateBuffer);e.skipUpdateBuffer||i.emit("ButtonScript.renderToPick");var a=o.world.entityManager.getEntityByIndex(r.id);e.mouseState.downOnEntity=!1,a===e.entity&&(i.emit(t.channel+"."+n,{type:n,entity:a}),("mousedown"===n||"touchstart"===n)&&(e.mouseState.downOnEntity=!0),t.linkUrl&&"click"===n&&window.open(t.linkUrl,t.linkTarget)),"mousemove"!==n||e.mouseState.overEntity||a!==e.entity||i.emit(t.channel+".mouseover",{type:"mouseover",entity:a}),"mousemove"===n&&e.mouseState.overEntity&&a!==e.entity&&i.emit(t.channel+".mouseout",{type:"mouseout",entity:a}),e.mouseState.overEntity=a===e.entity}return{setup:t,update:n,cleanup:o}}return r.externals={key:"ButtonScript",name:"Button",description:"Enables an entity to be interacted with using click or touch.",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"button",name:"button",description:"Only interact with this mouse button.",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"linkUrl",name:"linkUrl",description:"URL to open when clicking the entity. Leave this field empty to disable.",type:"string","default":""},{key:"linkTarget",name:"linkTarget",description:"The window to open the link in.",type:"string","default":"_blank"},{key:"channel",name:"channel",description:"Event channel to emit to. Will emit channel.click, .mousedown, .mouseup, .mouseover, .mouseout, .dblclick, .touchstart, .touchend",type:"string","default":"button"},{key:"enableOnMouseMove",name:"enableOnMouseMove",description:"Enables .mousemove, .mouseover, and .mouseout events. For larger scenes, this might be worth turning off, for better performance.",type:"boolean","default":!0}]},r}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.SystemBus),goo.CannonPickScript=function(t,e,n,o,i){"use strict";function r(){function e(t){var e=t[0].clientX,n=t[0].clientY,o=t[1].clientX,i=t[1].clientY,r=(e+o)/2,a=(n+i)/2;return[r,a]}function n(t,n){d=["Any","Left","Middle","Right"].indexOf(t.pickButton)-1,-1>d&&(d=-1),m=n.world.getSystem("CannonSystem");var o=new a.Sphere(.1),i=n.jointBody=new a.RigidBody(0,o);i.collisionFilterGroup=2,i.collisionFilterMask=2,m.world.add(i),p={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1};var r=n.listeners={mousedown:function(e){if(!t.whenUsed||n.entity===n.activeCameraEntity){var o=e.button;0===o&&(e.altKey?o=2:e.shiftKey&&(o=1)),(o===d||-1===d)&&(p.down=!0,p.ox=p.x=e.clientX,p.oy=p.y=e.clientY)}},mouseup:function(t){var e=t.button;0===e&&(t.altKey?e=2:t.shiftKey&&(e=1)),(e===d||-1===d)&&(p.down=!1,p.dx=p.dy=0)},mousemove:function(e){t.whenUsed&&n.entity!==n.activeCameraEntity||p.down&&(p.x=e.clientX,p.y=e.clientY,n.dirty=!0)},mouseleave:function(){p.down=!1,p.ox=p.x,p.oy=p.y},touchstart:function(o){if(!t.whenUsed||n.entity===n.activeCameraEntity){if(p.down=2===o.targetTouches.length,!p.down)return;var i=e(o.targetTouches);p.ox=p.x=i[0],p.oy=p.y=i[1]}},touchmove:function(o){if(!t.whenUsed||n.entity===n.activeCameraEntity){if(!p.down)return;var i=e(o.targetTouches);p.x=i[0],p.y=i[1]}},touchend:function(){p.down=!1,p.ox=p.x,p.oy=p.y}};for(var s in r)n.domElement.addEventListener(s,r[s]);n.dirty=!0}function r(e,n){p.dx=p.x-p.ox,p.dy=p.y-p.oy,p.ox=p.x,p.oy=p.y;var i=o.mainCamera;if(i&&p.down&&!n.mouseConstraint){for(var r=[],s=n.world.by.system("CannonSystem").toArray(),d=0;d<s.length;d++){var m=s[d].cannonRigidbodyComponent.body;m&&m.shape instanceof a.Box&&m.motionstate===a.Body.DYNAMIC&&r.push(m)}var h=i.getPickRay(p.x,p.y,window.innerWidth,window.innerHeight),y=new a.Vec3(h.origin.x,h.origin.y,h.origin.z),g=new a.Vec3(h.direction.x,h.direction.y,h.direction.z),v=new a.Ray(y,g),w=v.intersectBodies(r);if(w.length){var m=w[0].body,S=w[0].point;c(e,n,S.x,S.y,S.z,m,h.direction.scale(-1))}}else if(i&&p.down&&n.mouseConstraint&&(0!==p.dx||0!==p.dy)){var i=o.mainCamera,h=i.getPickRay(p.x,p.y,window.innerWidth,window.innerHeight),x=new t;f.rayIntersect(h,x,!0),l(e,n,x)}else p.down||u(e,n)}function s(t,e){for(var n in e.listeners)e.domElement.removeEventListener(n,e.listeners[n])}function c(e,n,o,i,r,s,c){n.constrainedBody=s;var l=new a.Vec3(o,i,r).vsub(n.constrainedBody.position),u=n.constrainedBody.quaternion.inverse(),d=u.vmult(l);n.jointBody.position.set(o,i,r),n.mouseConstraint=new a.PointToPointConstraint(n.constrainedBody,d,n.jointBody,new a.Vec3(0,0,0)),m.world.addConstraint(n.mouseConstraint);var p=new t(o,i,r);f.constant=p.dot(c),f.normal.set(c)}function l(t,e,n){e.jointBody.position.set(n.x,n.y,n.z),e.mouseConstraint.update()}function u(t,e){m.world.removeConstraint(e.mouseConstraint),e.mouseConstraint=!1}var d,p,m,f=new i;return{setup:n,update:r,cleanup:s}}var a=window.CANNON;return r.externals={key:"CannonPickScript",name:"Cannon.js Body Pick",description:"Enables the user to physically pick a Cannon.js physics body and drag it around.",parameters:[{key:"whenUsed",type:"boolean","default":!0},{key:"pickButton",name:"Pan button",description:"Pick with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"useForceNormal",name:"Use force normal",type:"boolean","default":!1},{key:"forceNormal",name:"Force normal","default":[0,0,1],type:"vec3"}]},r}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.Plane),goo.WasdControlScript=function(t,e,n){"use strict";function o(){function e(){y.x=m.strafeLeft-m.strafeRight,y.z=m.forward-m.back}function o(t){if(!t.altKey)switch(n.keyForCode(t.keyCode)){case p.crawlKey:m.speed=p.crawlSpeed;break;case p.forwardKey:m.forward=1,e();break;case p.backKey:m.back=1,e();break;case p.strafeLeftKey:m.strafeLeft=1,e();break;case p.strafeRightKey:m.strafeRight=1,e()}}function i(t){if(!t.altKey)switch(n.keyForCode(t.keyCode)){case p.crawlKey:m.speed=p.walkSpeed;break;case p.forwardKey:m.forward=0,e();break;case p.backKey:m.back=0,e();break;case p.strafeLeftKey:m.strafeLeft=0,e();break;case p.strafeRightKey:m.strafeRight=0,e()}}function r(t){t.setAttribute("tabindex",-1),t.addEventListener("keydown",o,!1),t.addEventListener("keyup",i,!1)}function a(t,e){p=t,e.moveState=m={strafeLeft:0,strafeRight:0,forward:0,back:0,crawling:!1,speed:t.walkSpeed},l=e.entity,u=l.transformComponent,d=u.transform,r(e.domElement)}function s(e,n){if(!(y.equals(t.ZERO)||e.whenUsed&&n.entity!==n.activeCameraEntity)){g.setDirect(f.x*y.z+h.x*y.x,f.y*y.z+h.y*y.x,f.z*y.z+h.z*y.x),g.normalize();var o=n.world.tpf*m.speed;g.scale(o);var i=d.rotation;g.applyPost(i),d.translation.add(g),u.setUpdated()}}function c(t,e){e.domElement.removeEventListener("keydown",o,!1),e.domElement.removeEventListener("keyup",i,!1)}var l,u,d,p,m,f=new t(0,0,-1),h=new t(-1,0,0),y=new t,g=new t;return{setup:a,update:s,cleanup:c}}return o.externals={key:"WASD",name:"WASD Control",description:"Enables moving via the WASD keys",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"crawlKey",type:"string",control:"key","default":"Shift"},{key:"forwardKey",type:"string",control:"key","default":"W"},{key:"backKey",type:"string",control:"key","default":"S"},{key:"strafeLeftKey",type:"string",control:"key","default":"A"},{key:"strafeRightKey",type:"string",control:"key","default":"D"},{key:"walkSpeed",type:"int",control:"slider","default":10,min:1,max:100,exponential:!0},{key:"crawlSpeed",control:"slider",type:"int","default":1,min:.1,max:10,exponential:!0}]},o}(goo.Vector3,goo.Scripts,goo.ScriptUtils),goo.MouseLookControlScript=function(t,e,n,o){"use strict";function i(){function t(t){f.whenUsed&&m.entity!==m.activeCameraEntity||(-1===p||t.button===p)&&(y=!0,g=w=t.clientX,v=S=t.clientY)}function i(){document.pointerLockElement||o.requestPointerLock()}function r(t){f.whenUsed&&m.entity!==m.activeCameraEntity||y&&(void 0!==t.movementX?(w+=t.movementX,S+=t.movementY):(w=t.clientX,S=t.clientY))}function a(){y=!1}function s(){y=!!document.pointerLockElement,document.pointerLockElement?m.domElement.removeEventListener("mousedown",i):m.domElement.addEventListener("mousedown",i)}function c(n,c){m=c,f=n,p=["Any","Left","Middle","Right","None"].indexOf(n.button)-1,-1>p&&(p=-1);var l=c.domElement;3===p?(document.addEventListener("pointerlockchange",s),document.addEventListener("mousemove",r),l.addEventListener("mousedown",i),o.requestPointerLock()):(l.addEventListener("mousedown",t),l.addEventListener("mouseup",a),l.addEventListener("mouseleave",a),l.addEventListener("mousemove",r)),d=new e;var u=c.entity.transformComponent.transform.rotation;u.toAngles(d),h=d.y}function l(t,e){if(w!==g||S!==v){var o=w-g,i=S-v,r=e.entity,a=r.transformComponent.transform.rotation;a.toAngles(d);var s=d.x,c=d.y,l=t.maxAscent*n.DEG_TO_RAD,u=t.minAscent*n.DEG_TO_RAD;s=n.clamp(s-i*t.speed/200,u,l);var p=t.maxAzimuth*n.DEG_TO_RAD-h,m=t.minAzimuth*n.DEG_TO_RAD-h;c-=o*t.speed/200,t.clampAzimuth&&(c=n.radialClamp(c,m,p)),a.fromAngles(s,c,0),r.transformComponent.setUpdated(),g=w,v=S}}function u(e,n){var c=n.domElement;3===p?(o.exitPointerLock(),document.removeEventListener("mousemove",r),c.removeEventListener("mousedown",i),document.removeEventListener("pointerlockchange",s)):(c.removeEventListener("mousemove",r),c.removeEventListener("mousedown",t),c.removeEventListener("mouseup",a),c.removeEventListener("mouseleave",a))}var d,p,m,f,h,y=!1,g=0,v=0,w=0,S=0;return{setup:c,update:l,cleanup:u}}return i.externals={key:"MouseLookScript",name:"Mouse Look Control",description:"Click and drag to change rotation of entity, usually a camera",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"button",name:"Mouse button",type:"string",control:"select","default":"Left",options:["Any","Left","Middle","Right","None"]},{key:"speed",name:"Turn Speed",type:"float",control:"slider","default":1,min:-10,max:10,scale:.1},{key:"maxAscent",name:"Max Ascent",type:"float",control:"slider","default":89.95,min:-89.95,max:89.95},{key:"minAscent",name:"Min Ascent",type:"float",control:"slider","default":-89.95,min:-89.95,max:89.95},{key:"clampAzimuth","default":!1,type:"boolean"},{key:"minAzimuth",description:"Maximum arc the camera can reach clockwise of the target point","default":-90,type:"int",control:"slider",min:-180,max:0},{key:"maxAzimuth",description:"Maximum arc the camera can reach counter-clockwise of the target point","default":90,type:"int",control:"slider",min:0,max:180}]},i}(goo.Scripts,goo.Vector3,goo.MathUtils,goo.GameUtils),goo.FlyControlScript=function(t,e,n){"use strict";function o(){function o(t,e){s.setup(t,e),a.setup(t,e)}function i(t,e){s.update(t,e),a.update(t,e)}function r(t,e){s.cleanup(t,e),a.cleanup(t,e)}var a=t.create(e),s=t.create(n);return{setup:o,cleanup:r,update:i}}var i=e.externals.parameters,r=n.externals.parameters,a=i.concat(r.slice(1));return o.externals={key:"FlyControlScript",name:"Fly Control",description:"This is a combo of the Wasd script and the MouseLook script",parameters:a},o}(goo.Scripts,goo.WasdControlScript,goo.MouseLookControlScript),goo.GroundBoundMovementScript=function(t){"use strict";function e(e){e=e||{};for(var n in o)"boolean"==typeof o[n]?this[n]=void 0!==e[n]?e[n]===!0:o[n]:isNaN(o[n])?o[n]instanceof t?this[n]=e[n]?new t(e[n]):(new t).set(o[n]):this[n]=e[n]||o[n]:this[n]=isNaN(e[n])?o[n]:e[n];this.groundContact=1,this.targetVelocity=new t,this.targetHeading=new t,this.acceleration=new t,this.torque=new t,this.groundHeight=0,this.groundNormal=new t,this.controlState={run:0,strafe:0,jump:0,yaw:0,roll:0,pitch:0}}var n=new t,o={gravity:-9.81,worldFloor:-(1/0),jumpImpulse:95,accLerp:.1,rotLerp:.1,modForward:1,modStrafe:.7,modBack:.4,modTurn:.3};return e.prototype.setTerrainSystem=function(t){this.terrainScript=t},e.prototype.getTerrainSystem=function(){return this.terrainScript},e.prototype.getTerrainHeight=function(t){var e=this.getTerrainSystem().getTerrainHeightAt(t);return null===e&&(e=this.worldFloor),e},e.prototype.getTerrainNormal=function(t){return this.getTerrainSystem().getTerrainNormalAt(t)},e.prototype.applyForward=function(t){this.controlState.run=t},e.prototype.applyStrafe=function(t){this.controlState.strafe=t},e.prototype.applyJump=function(t){this.controlState.jump=t},e.prototype.applyTurn=function(t){this.controlState.yaw=t},e.prototype.applyJumpImpulse=function(t){return this.groundContact&&(this.controlState.jump?(t=this.jumpImpulse,this.controlState.jump=0):t=0),t},e.prototype.applyDirectionalModulation=function(t,e,n){t*=this.modStrafe,n*=n>0?this.modForward:this.modBack,this.targetVelocity.setDirect(t,this.applyJumpImpulse(e),n)},e.prototype.applyTorqueModulation=function(t,e,n){this.targetHeading.setDirect(t,e*this.modTurn,n)},e.prototype.applyGroundNormalInfluence=function(){var t=Math.abs(Math.cos(this.groundNormal.x)),e=Math.abs(Math.cos(this.groundNormal.z));this.targetVelocity.x*=t,this.targetVelocity.z*=e},e.prototype.updateTargetVectors=function(t){this.applyDirectionalModulation(this.controlState.strafe,this.gravity,this.controlState.run),this.targetVelocity.applyPost(t.rotation),this.applyGroundNormalInfluence(),this.applyTorqueModulation(this.controlState.pitch,this.controlState.yaw,this.controlState.roll)},e.prototype.computeAcceleration=function(t,e,o){return n.set(o),n.applyPost(t.transformComponent.transform.rotation),n.sub(e),n.lerp(o,this.accLerp),n.y=o.y,n},e.prototype.computeTorque=function(t,e){return n.set(e),n.sub(t),n.lerp(e,this.rotLerp),n},e.prototype.updateVelocities=function(t){var e=t.movementComponent.getVelocity(),n=t.movementComponent.getRotationVelocity();this.acceleration.set(this.computeAcceleration(t,e,this.targetVelocity)),this.torque.set(this.computeTorque(n,this.targetHeading))},e.prototype.applyAccelerations=function(t){t.movementComponent.addVelocity(this.acceleration),t.movementComponent.addRotationVelocity(this.torque)},e.prototype.updateGroundNormal=function(t){this.groundNormal.set(this.getTerrainNormal(t.translation))},e.prototype.checkGroundContact=function(t,e){this.groundHeight=this.getTerrainHeight(e.translation),e.translation.y<=this.groundHeight?(this.groundContact=1,this.updateGroundNormal(e)):this.groundContact=0},e.prototype.applyGroundContact=function(t,e){this.groundHeight>=e.translation.y&&(e.translation.y=this.groundHeight,t.movementComponent.velocity.y<0&&(t.movementComponent.velocity.y=0))},e.prototype.run=function(t){var e=t.transformComponent.transform;this.checkGroundContact(t,e),this.updateTargetVectors(e),this.updateVelocities(t),this.applyAccelerations(t),this.applyGroundContact(t,e)},e}(goo.Vector3),goo.HeightMapBoundingScript=function(t){"use strict";function e(t){this.matrixData=t,this.width=t.length-1}return e.prototype.getMatrixData=function(){return this.matrixData},e.prototype.getPointInMatrix=function(t,e){return this.matrixData[t][e]},e.prototype.getAt=function(t,e){return 0>t||t>this.width||0>e||e>this.width?0:this.getPointInMatrix(t,e)},e.prototype.getInterpolated=function(t,e){var n=this.getAt(Math.ceil(t),Math.ceil(e)),o=this.getAt(Math.ceil(t),Math.floor(e)),i=this.getAt(Math.floor(t),Math.ceil(e)),r=this.getAt(Math.floor(t),Math.floor(e)),a=t-Math.floor(t),s=e-Math.floor(e),c=n*a+i*(1-a),l=o*a+r*(1-a),u=c*s+l*(1-s);return u},e.prototype.getTriangleAt=function(t,e){var n,o=Math.ceil(t),i=Math.floor(t),r=Math.ceil(e),a=Math.floor(e),s=t-i,c=e-a,l={x:i,y:r,z:this.getAt(i,r)},u={x:o,y:a,z:this.getAt(o,a)};return n=1-c>s?{x:i,y:a,z:this.getAt(i,a)}:{x:o,y:r,z:this.getAt(o,r)},[l,u,n]},e.prototype.getPreciseHeight=function(e,n){var o=this.getTriangleAt(e,n),i=t.barycentricInterpolation(o[0],o[1],o[2],{x:e,y:n,z:0});return i.z},e.prototype.run=function(t){var e=t.transformComponent.transform.translation;e.y=this.getInterpolated(e.z,e.x)},e}(goo.MathUtils),goo.LensFlareScript=function(t,e,n,o,i){"use strict";function r(){function t(t){v.size=t,v.splash=e.createSplashTexture(512,{trailStartRadius:25,trailEndRadius:0}),v.ring=e.createFlareTexture(t,{steps:w.ring,startRadius:t/4,endRadius:t/2}),v.dot=e.createFlareTexture(t,{steps:w.dot,startRadius:0,endRadius:t/2}),v.bell=e.createFlareTexture(t,{steps:w.bell,startRadius:0,endRadius:t/2}),v["default"]=e.createFlareTexture(t,{steps:w.none,startRadius:0,endRadius:t/2})}function n(t,e,n,o,i){for(var r=0;r<t.length;r++){var a=t[r];y.push(new s(e,a.tx,a.displace,a.size,a.intensity*f,n,o,i,v,u))}return y}function o(t){for(var e=0;e<t.length;e++)t[e].quad.removeFromWorld()}function i(e,n){f=e.intensity,h=new a(100*e.edgeRelevance);var o=g;e.highRes&&(o*=4),v.size!==o&&t(o),y=[],l=n.entity,u=n.world,d=!1,m=[e.color[0],e.color[1],e.color[2],1],p=[{size:2.53,tx:"bell",intensity:.7,displace:1},{size:.53,tx:"dot",intensity:.7,displace:1},{size:.83,tx:"bell",intensity:.2,displace:.8},{size:.4,tx:"ring",intensity:.1,displace:.6},{size:.3,tx:"bell",intensity:.1,displace:.4},{size:.6,tx:"bell",intensity:.1,displace:.3},{size:.3,tx:"dot",intensity:.1,displace:.15},{size:.22,tx:"ring",intensity:.03,displace:-.25},{size:.36,tx:"dot",intensity:.05,displace:-.5},{size:.8,tx:"ring",intensity:.1,displace:-.8},{size:.86,tx:"bell",intensity:.2,displace:-1.1},{size:1.3,tx:"ring",intensity:.05,displace:-1.5}]}function r(){o(y),y=[]}function c(t,e){if(e.entity.isVisible!==!1){h.updateFrameGeometry(l,e.activeCameraEntity),d||(y=n(p,m,t.scale,t.edgeDampen,t.edgeScaling),d=!0);for(var i=0;i<y.length;i++)y[i].updatePosition(h)}else d&&(o(y),d=!1)}var l,u,d,p,m,f,h,y=[],g=64,v={},w={splash:{trailStartRadius:25,trailEndRadius:0},ring:[{fraction:0,value:0},{fraction:.7,value:0},{fraction:.92,value:1},{fraction:.98,value:0}],dot:[{fraction:0,value:1},{fraction:.3,value:.75},{fraction:.5,value:.45},{fraction:.65,value:.21},{fraction:.75,value:.1},{fraction:.98,value:0}],bell:[{fraction:0,value:1},{fraction:.15,value:.75},{fraction:.3,value:.5},{fraction:.4,value:.25},{fraction:.75,value:.05},{fraction:.98,value:0}],none:[{fraction:0,value:1},{fraction:1,value:0}]};return{setup:i,update:c,cleanup:r}}function a(e){this.camRot=null,this.distance=0,this.offset=0,this.centerRatio=0,this.positionVector=new t,this.distanceVector=new t,this.centerVector=new t,this.displacementVector=new t,this.edgeRelevance=e}function s(e,r,a,s,c,l,u,d,p,m){this.sizeVector=new t(s,s,s),this.sizeVector.scale(l),this.positionVector=new t,this.flareVector=new t,this.intensity=c,this.displace=a,this.color=[e[0]*c,e[1]*c,e[2]*c,1],this.edgeDampen=u,this.edgeScaling=d;var f=new n(o.uber,"flareShader");f.uniforms.materialEmissive=this.color,f.uniforms.materialDiffuse=[0,0,0,1],f.uniforms.materialAmbient=[0,0,0,1],f.uniforms.materialSpecular=[0,0,0,1];var h=p[r];f.setTexture("DIFFUSE_MAP",h),f.setTexture("EMISSIVE_MAP",h),f.blendState.blending="AdditiveBlending",f.blendState.blendEquation="AddEquation",f.blendState.blendSrc="OneFactor",f.blendState.blendDst="OneFactor",f.depthState.enabled=!1,f.depthState.write=!1,f.cullState.enabled=!1;var y=new i(1,1),g=m.createEntity(y,f);g.meshRendererComponent.cullMode="Never",g.addToWorld(),this.material=f,this.quad=g}return r.externals={key:"LensFlareScript",name:"Lens Flare Script",description:"Makes an entity shine with some lensflare effect.",parameters:[{key:"scale",name:"Scale",type:"float",description:"Scale of flare quads",control:"slider","default":1,min:.01,max:2},{key:"intensity",name:"Intensity",type:"float",description:"Intensity of Effect",control:"slider","default":1,min:.01,max:2},{key:"edgeRelevance",name:"Edge Relevance",type:"float",description:"How much the effect cares about being centered or not",control:"slider","default":0,min:0,max:2},{key:"edgeDampen",name:"Edge Dampening",type:"float",description:"Intensity adjustment by distance from center",control:"slider","default":.2,min:0,max:1},{key:"edgeScaling",name:"Edge Scaling",type:"float",description:"Scale adjustment by distance from center",control:"slider","default":0,min:-2,max:2},{key:"color",name:"Color",type:"vec3",description:"Effect Color",control:"color","default":[.8,.75,.7]},{key:"highRes",name:"High Resolution",type:"boolean",description:"Intensity of Effect",control:"checkbox","default":!1}]},a.prototype.updateFrameGeometry=function(t,e){this.camRot=e.transformComponent.transform.rotation,this.centerVector.set(e.cameraComponent.camera.translation),this.displacementVector.set(t.transformComponent.worldTransform.translation),this.displacementVector.sub(this.centerVector),this.distance=this.displacementVector.length(),this.distanceVector.setDirect(0,0,-this.distance),this.distanceVector.applyPost(this.camRot),this.centerVector.add(this.distanceVector),this.positionVector.set(this.centerVector),this.displacementVector.set(t.transformComponent.worldTransform.translation),this.displacementVector.sub(this.positionVector),this.offset=this.displacementVector.length();var n=this.positionVector.length();n?this.centerRatio=1-this.offset*this.edgeRelevance/this.positionVector.length():this.centerRatio=1-this.offset*this.edgeRelevance,this.centerRatio=Math.max(0,this.centerRatio)},s.prototype.updatePosition=function(t){this.flareVector.set(t.displacementVector),this.positionVector.set(t.positionVector),this.flareVector.scale(this.displace),this.positionVector.add(this.flareVector),this.material.uniforms.materialEmissive=[this.color[0]*t.centerRatio*this.edgeDampen,this.color[1]*t.centerRatio*this.edgeDampen,this.color[2]*t.centerRatio*this.edgeDampen,1];var e=t.distance+t.distance*t.centerRatio*this.edgeScaling,n=this.quad.transformComponent.transform;n.scale.set(this.sizeVector),n.scale.scale(e),n.rotation.set(t.camRot),n.translation.set(this.positionVector),this.quad.transformComponent.updateTransform(),this.quad.transformComponent.updateWorldTransform()},r}(goo.Vector3,goo.ParticleSystemUtils,goo.Material,goo.ShaderLib,goo.Quad),goo.PanCamScript=function(t,e,n,o,i,r){"use strict";function a(){function e(t){var e=t[0].clientX,n=t[0].clientY,o=t[1].clientX,i=t[1].clientY,r=(e+o)/2,a=(n+i)/2;return[r,a]}function n(n,o){p=["Any","Left","Middle","Right"].indexOf(n.panButton)-1,-1>p&&(p=-1),m=o.goingToLookAt,c=t.UNIT_Y.clone(),l=t.UNIT_X.clone().negate(),u=new t,d=new t;var i=o.world.gooRunner.renderer;o.devicePixelRatio=i._useDevicePixelRatio&&window.devicePixelRatio?window.devicePixelRatio/i.svg.currentScale:1,f={x:0,y:0,ox:0,oy:0,dx:0,dy:0,down:!1},h={mousedown:function(t){if(!n.whenUsed||o.entity===o.activeCameraEntity){var e=t.button;if(0===e&&(t.altKey?e=2:t.shiftKey&&(e=1)),e===p||-1===p){f.down=!0;var i=void 0!==t.offsetX?t.offsetX:t.layerX,r=void 0!==t.offsetY?t.offsetY:t.layerY;f.ox=f.x=i,f.oy=f.y=r}}},mouseup:function(t){var e=t.button;0===e&&(t.altKey?e=2:t.shiftKey&&(e=1)),f.down=!1,f.dx=f.dy=0},mousemove:function(t){if((!n.whenUsed||o.entity===o.activeCameraEntity)&&f.down){var e=void 0!==t.offsetX?t.offsetX:t.layerX,i=void 0!==t.offsetY?t.offsetY:t.layerY;f.x=e,f.y=i,o.dirty=!0}},mouseleave:function(){f.down=!1,f.ox=f.x,f.oy=f.y},touchstart:function(t){if(!n.whenUsed||o.entity===o.activeCameraEntity){if(f.down=2===t.targetTouches.length,!f.down)return;var i=e(t.targetTouches);f.ox=f.x=i[0],f.oy=f.y=i[1]}},touchmove:function(t){if(!n.whenUsed||o.entity===o.activeCameraEntity){if(!f.down)return;var i=e(t.targetTouches);f.x=i[0],f.y=i[1]}},touchend:function(){f.down=!1,f.ox=f.x,f.oy=f.y}};for(var r in h)o.domElement.addEventListener(r,h[r]);o.dirty=!0}function a(t,e){if(e.dirty){if(f.dx=f.x-f.ox,f.dy=f.y-f.oy,0===f.dx&&0===f.dy)return void(e.dirty=!!e.lookAtPoint);t.invertX&&(f.dx=-f.dx),t.invertY&&(f.dy=-f.dy),f.ox=f.x,f.oy=f.y;var n=o.mainCamera,a=e.entity,s=a.transformComponent.transform,p=a.cameraComponent.camera;if(m&&n){if(m.equals(n.translation))return;var h=e.viewportWidth/e.devicePixelRatio,y=e.viewportHeight/e.devicePixelRatio;
n.getScreenCoordinates(m,h,y,u),u.subDirect(f.dx,f.dy,0),n.getWorldCoordinates(u.x,u.y,h,y,u.z,u),m.set(u)}else{if(u.set(c).scale(f.dy),d.set(l).scale(f.dx),a.cameraComponent&&a.cameraComponent.camera){var p=a.cameraComponent.camera;u.scale((p._frustumTop-p._frustumBottom)/e.viewportHeight),d.scale((p._frustumRight-p._frustumLeft)/e.viewportWidth)}u.add(d),u.applyPost(s.rotation),p.projectionMode===r.Perspective?u.scale(20*t.panSpeed):u.scale(t.panSpeed),a.transformComponent.transform.translation.add(u),a.transformComponent.setUpdated(),e.dirty=!1}i.emit("goo.cameraPositionChanged",{translation:s.translation.toArray(),lookAtPoint:m?m.toArray():null,id:a.id})}}function s(t,e){for(var n in h)e.domElement.removeEventListener(n,h[n])}var c,l,u,d,p,m,f,h;return{setup:n,update:a,cleanup:s}}return a.externals={key:"PanCamControlScript",name:"PanCamera Control",description:"Enables camera to pan around a point in 3D space using the mouse",parameters:[{key:"whenUsed",type:"boolean",name:"When Camera Used",description:"Script only runs when the camera to which it is added is being used.","default":!0},{key:"panButton",name:"Pan button",description:"Only pan with this button",type:"string",control:"select","default":"Any",options:["Any","Left","Middle","Right"]},{key:"panSpeed",type:"float","default":1,scale:.01}]},a}(goo.Vector3,goo.Scripts,goo.ScriptUtils,goo.Renderer,goo.SystemBus,goo.Camera),goo.OrbitNPanControlScript=function(t,e,n,o){"use strict";function i(){function o(t,e,n){a.setup(t,e,n),s.setup(t,e,n)}function i(t,e,n){s.update(t,e,n),a.update(t,e,n)}function r(t,e,n){s.cleanup(t,e,n),a.cleanup(t,e,n)}var a=t.create(e),s=t.create(n);return{setup:o,cleanup:r,update:i}}for(var r=e.externals.parameters,a=n.externals.parameters,s=o.deepClone(r.concat(a.slice(1))),c=0;c<s.length;c++){var l=s[c];if("panSpeed"===l.key){s.splice(c,1);break}}for(var c=0;c<s.length;c++){var l=s[c];switch(l.key){case"dragButton":l["default"]="Left";break;case"panButton":l["default"]="Right";break;case"panSpeed":l["default"]=1}}return i.externals={key:"OrbitNPanControlScript",name:"Orbit and Pan Control",description:"This is a combo of orbitcamcontrolscript and pancamcontrolscript",parameters:s},i}(goo.Scripts,goo.OrbitCamControlScript,goo.PanCamScript,goo.ObjectUtils),goo.PickAndRotateScript=function(){"use strict";function t(){function t(t){var e=t.button;return 0===e&&(t.altKey?e=2:t.shiftKey&&(e=1)),e}function e(e){if(!u.disable){var o=t(e.domEvent);o!==d.dragButton&&-1!==d.dragButton||!e.entity||(l=!1,e.entity.traverseUp(function(t){return t===d.entity?(l=!0,!1):void 0}),l&&n(e))}}function n(t){p.x=t.x,p.y=t.y,p.oldX=p.x,p.oldY=p.y,p.down=!0}function o(t){if(p.oldX=p.x,p.oldY=p.y,p.x=t.clientX||t.touches[0].clientX,p.y=t.clientY||t.touches[0].clientY,l&&p.down){var e=p.x-p.oldX,n=p.y-p.oldY;p.ax+=e,p.ay+=n,d.entity.transformComponent.transform.rotation.setIdentity(),d.entity.transformComponent.transform.rotation.rotateX(p.ay/300*u.yMultiplier),d.entity.transformComponent.transform.rotation.rotateY(p.ax/200*u.xMultiplier),d.entity.transformComponent.setUpdated()}}function i(t){p.down=!1}function r(t,n,r){u=t,d=n,d.dragButton=["Any","Left","Middle","Right"].indexOf(u.dragButton)-1,d.dragButton<-1&&(d.dragButton=-1),c=d.world.gooRunner,c.addEventListener("mousedown",e),c.addEventListener("touchstart",e),c.renderer.domElement.addEventListener("mousemove",o),c.renderer.domElement.addEventListener("touchmove",o),c.renderer.domElement.addEventListener("mouseup",i),c.renderer.domElement.addEventListener("touchend",i),p={down:!1,x:0,y:0,oldX:0,oldY:0,ax:0,ay:0}}function a(t,e,n){}function s(t,n,r){n.domElement.removeEventListener("mousemove",o),n.domElement.removeEventListener("touchmove",o),n.domElement.removeEventListener("mouseup",i),n.domElement.removeEventListener("touchend",i),c.removeEventListener("mousedown",e),c.removeEventListener("touchstart",e)}var c,l,u,d,p;return{setup:r,update:a,cleanup:s}}return t.externals={key:"PickAndRotateScript",name:"Pick and Rotate",description:"Enables pick-drag-rotating entities",parameters:[{key:"disable",description:"Prevent rotation. For preventing this script programmatically.",type:"boolean","default":!1},{key:"dragButton",description:"Button to enable dragging","default":"Any",options:["Any","Left","Middle","Right"],type:"string",control:"select"},{key:"xMultiplier",description:"Horizontal rotation multiplier","default":1,type:"float",control:"slider",min:-4,max:4},{key:"yMultiplier",description:"Vertical rotation multiplier","default":1,type:"float",control:"slider",min:-4,max:4}]},t}(),goo.PolyBoundingScript=function(){"use strict";function t(t){this.collidables=t||[]}return t.prototype.addCollidable=function(t){this.collidables.push(t)},t.prototype.removeAllAt=function(t,e,n){this.collidables=this.collidables.filter(function(o){return o.bottom<=n&&o.top>=n?!window.PolyK.ContainsPoint(o.poly,t,e):void 0})},t.prototype.inside=function(t,e,n){for(var o=0;o<this.collidables.length;o++){var i=this.collidables[o];if(i.bottom<=e&&i.top>=e&&window.PolyK.ContainsPoint(i.poly,t,n))return window.PolyK.ClosestEdge(i.poly,t,n)}},t.prototype.run=function(t){for(var e=t.transformComponent,n=e.transform.translation,o=0;o<this.collidables.length;o++){var i=this.collidables[o];if(i.bottom<=n.y&&i.top>=n.y&&window.PolyK.ContainsPoint(i.poly,n.x,n.z)){var r=window.PolyK.ClosestEdge(i.poly,n.x,n.z);return n.x=r.point.x,n.z=r.point.y,void e.setUpdated()}}},t}(),goo.RotationScript=function(){"use strict";function t(){function t(t,e){i={x:0,y:0},r={x:0,y:0},a=e.entity,document.addEventListener("mousemove",n)}function e(t){r.x+=(i.x-r.x)*t.fraction,r.y+=(i.y-r.y)*t.fraction,a.setRotation(r.y/200,r.x/200,0)}function n(t){i.x=t.x,i.y=t.y}function o(){document.removeEventListener("mousemove",n)}var i,r,a;return{setup:t,update:e,cleanup:o}}return t.externals={key:"RotationScript",name:"Mouse Rotation",description:"",parameters:[{key:"fraction",name:"Speed","default":.01,type:"float",control:"slider",min:.01,max:1}]},t}(),goo.ScriptComponentHandler=function(t,e,n,o,i,r,a,s){"use strict";function c(){t.apply(this,arguments),this._type="ScriptComponent"}function l(t){var e=a.create(t);if(!e)throw new Error("Unrecognized script name");return e.id=c.ENGINE_SCRIPT_PREFIX+t,e.enabled=!1,r.emit("goo.scriptExternals",{id:e.id,externals:e.externals}),i.resolve(e)}return c.prototype=Object.create(t.prototype),c.prototype.constructor=c,t._registerClass("script",c),c.ENGINE_SCRIPT_PREFIX="GOO_ENGINE_SCRIPTS/",c.prototype._prepare=function(){},c.prototype._create=function(){return new e},c.prototype.update=function(e,i,r){var a=this;return t.prototype.update.call(this,e,i,r).then(function(t){if(t){var e=[];return o.forEach(i.scripts,function(t){var n=t.scriptRef,i=0===n.indexOf(c.ENGINE_SCRIPT_PREFIX),u=null;if(i){var d=n.slice(c.ENGINE_SCRIPT_PREFIX.length);u=l(d)}else u=a._load(t.scriptRef,{reload:!0});u=u.then(function(e){t.options=t.options||{},e.parameters&&o.defaults(t.options,e.parameters),e.externals&&e.externals.parameters&&s.fillDefaultValues(t.options,e.externals.parameters);var n=Object.create(e);return n.parameters={},n.enabled=!1,a._setParameters(n.parameters,t.options,e.externals,r).then(function(){return n})}),e.push(u)},null,"sortValue"),n.all(e).then(function(e){return t.scripts=e,t})}})},c.prototype._setParameters=function(t,e,o,r){if(!o||!o.parameters)return i.resolve();var a=o.parameters.map(function(n){return this._setParameter(t,e[n.key],n,r)},this);return t.enabled=e.enabled!==!1,n.all(a)},c.prototype._setParameter=function(t,e,n,r){var a=n.key;return s.typeValidators[n.type](e)?"texture"===n.type?e&&e.textureRef&&e.enabled!==!1?this._load(e.textureRef,r).then(function(e){t[a]=e}):(t[a]=null,i.resolve()):"entity"===n.type?e&&e.entityRef&&e.enabled!==!1?(this._load(e.entityRef,r).then(function(e){t[a]=e}),i.resolve()):(t[a]=null,i.resolve()):(t[a]=o.clone(e),i.resolve()):("undefined"==typeof n["default"]?t[a]=o.deepClone(s.defaultsByType[n.type]):t[a]=o.deepClone(n["default"]),i.resolve())},c}(goo.ComponentHandler,goo.ScriptComponent,goo.rsvp,goo.ObjectUtils,goo.PromiseUtils,goo.SystemBus,goo.Scripts,goo.ScriptUtils),goo.ScriptHandler=function(t,e,n,o,i,r,a,s,c,l,u,d,p){"use strict";function m(){t.apply(this,arguments),this._scriptElementsByURL=new Map,this._bodyCache={},this._dependencyPromises={},this._currentScriptLoading=null,this._addGlobalErrorListener()}function f(t,e){if(!t.scriptRefs)return void(t.scriptRefs=[e]);var n=t.scriptRefs.indexOf(e);-1===n&&t.scriptRefs.push(e)}function h(t,e){t.scriptRefs&&l.remove(t.scriptRefs,e)}function y(t){return t.scriptRefs&&t.scriptRefs.length>0}function g(t,e){return t.scriptRefs&&t.scriptRefs.indexOf(e)>-1}function v(t){for(var e=[],n=document.querySelectorAll("script"),o=0;o<n.length;++o){var i=n[o];g(i,t)&&e.push(i)}return e}function w(){for(var t=document.querySelectorAll("script"),e=0;e<t.length;++e){var n=t[e];n.isDependency&&!y(n)&&n.parentNode&&n.parentNode.removeChild(n)}}function S(t,e,n){return s.createPromise(function(o,i){function r(i){var r={message:i,file:n};x(t,r),e.parentNode&&e.parentNode.removeChild(e),o()}var a,s=!1;e.onload=function(){o(),a&&clearTimeout(a)},e.onerror=function(t){s=!0,a&&clearTimeout(a),console.error(t),r("Could not load dependency "+n)},s||(s=!0,a=setTimeout(function(){r("Loading dependency "+n+" failed (time out)")},b))})}function x(t,e){if(e.file){var n=e.message;e.line&&(n+=" - on line "+e.line),t.dependencyErrors=t.dependencyErrors||{},t.dependencyErrors[e.file]=e}else{t.errors=t.errors||[];var n=e.message;e.line&&(n+=" - on line "+e.line),t.errors.push(e),t.setup=null,t.update=null,t.run=null,t.cleanup=null,t.parameters={},t.enabled=!1}}var b=6e3;m.prototype=Object.create(t.prototype),m.prototype.constructor=m,t._registerClass("script",m),m.prototype._create=function(){return{externals:{},setup:null,update:null,run:null,cleanup:null,parameters:{},name:null}},m.prototype._remove=function(t){var e=this._objects.get(t);if(e&&e.cleanup&&e.context)try{e.cleanup(e.parameters,e.context,window.goo)}catch(n){}this._objects["delete"](t),delete this._bodyCache[t]},m.prototype._updateFromCustom=function(t,e){if(this._bodyCache[e.id]===e.body)return t;delete t.errors,this._bodyCache[e.id]=e.body;var n=document.getElementById(m.DOM_ID_PREFIX+e.id);n&&n.parentNode.removeChild(n),window._gooScriptFactories||(window._gooScriptFactories={});var o=["// <![CDATA[","window._gooScriptFactories['"+e.id+"'] = function () {",e.body," var obj = {","  externals: {}"," };",' if (typeof parameters !== "undefined") {',"  obj.externals.parameters = parameters;"," }",' if (typeof setup !== "undefined") {',"  obj.setup = setup;"," }",' if (typeof cleanup !== "undefined") {',"  obj.cleanup = cleanup;"," }",' if (typeof update !== "undefined") {',"  obj.update = update;"," }"," return obj;","};","// ]]>"].join("\n"),i=document.createElement("script");i.id=m.DOM_ID_PREFIX+e.id,i.innerHTML=o,i.async=!1,this._currentScriptLoading=e.id;var r=this.world.gooRunner.renderer.domElement.parentElement||document.body;r.appendChild(i);var a=window._gooScriptFactories[e.id];if(a){try{var s=a();t.id=e.id,m.validateParameters(s,t),t.setup=s.setup,t.update=s.update,t.cleanup=s.cleanup,t.parameters={},t.enabled=!1}catch(c){var l={message:c.toString()};if(c instanceof Error){var u=c.stack.split("\n")[1].match(/(\d+):\d+\)$/);u&&(l.line=parseInt(u[1],10)-1)}x(t,l)}this._currentScriptLoading=null}return t.externals&&d.fillDefaultNames(t.externals.parameters),t},m.prototype._updateFromClass=function(t,e){if(!t.externals||t.externals.name!==e.className){var n=p.create(e.className);if(!n)throw new Error("Unrecognized script name");t.id=e.id,t.externals=n.externals,t.setup=n.setup,t.update=n.update,t.run=n.run,t.cleanup=n.cleanup,t.parameters=n.parameters||{},t.enabled=!1,d.fillDefaultNames(t.externals.parameters)}return t},m.prototype._addDependency=function(t,e,n){var o=this,i=document.querySelector('script[src="'+e+'"]');if(i)return f(i,n),this._dependencyPromises[e]||s.resolve();i=document.createElement("script"),i.src=e,i.setAttribute("data-script-id",n),i.isDependency=!0,i.async=!1,this._scriptElementsByURL.set(e,i),f(i,n);var r=S(t,i,e).then(function(){delete o._dependencyPromises[e]});return this._dependencyPromises[e]=r,r},m.prototype._update=function(n,o,i){var r=this;return t.prototype._update.call(this,n,o,i).then(function(t){if(t){var a=[];if(o.body&&o.dependencies){delete t.dependencyErrors;var s=v(o.id);c.forEach(o.dependencies,function(e){var n=e.url,i=l.find(s,function(t){return t.src===n});i&&l.remove(s,i),a.push(r._addDependency(t,n,o.id))},null,"sortValue"),c.forEach(s,function(t){h(t,o.id)})}var d=r.world.gooRunner.renderer.domElement.parentElement||document.body;return c.forEach(o.dependencies,function(t){var e=r._scriptElementsByURL.get(t.url);d.appendChild(e)},null,"sortValue"),e.all(a).then(function(){return o.className?r._updateFromClass(t,o,i):o.body&&r._updateFromCustom(t,o,i),o.body&&u.emit("goo.scriptExternals",{id:o.id,externals:t.externals}),t.name=o.name,t.errors||t.dependencyErrors?(u.emit("goo.scriptError",{id:n,errors:t.errors,dependencyErrors:t.dependencyErrors}),t):(u.emit("goo.scriptError",{id:n,errors:null}),c.extend(t.parameters,o.options),w(),t)})}})},m.prototype._addGlobalErrorListener=function(){var t=this;window.addEventListener("error",function(e){if(e.filename){var n=document.querySelector('script[src="'+e.filename+'"]');if(n){var o=n.getAttribute("data-script-id"),i=t._objects.get(o);if(i){var r={message:e.message,line:e.lineno,file:e.filename};x(i,r)}n.parentNode.removeChild(n)}}if(t._currentScriptLoading){var a=document.getElementById(m.DOM_ID_PREFIX+t._currentScriptLoading);a&&a.parentNode.removeChild(a),delete window._gooScriptFactories[t._currentScriptLoading];var i=t._objects.get(t._currentScriptLoading),r={message:e.message,line:e.lineno-1};x(i,r),t._currentScriptLoading=null}})};var k=["string","int","float","vec2","vec3","vec4","boolean","texture","image","sound","camera","entity","animation"],E=function(){var t={string:["key"],"int":["spinner","slider","jointSelector"],"float":["spinner","slider"],vec2:[],vec3:["color"],vec4:["color"],"boolean":["checkbox"],texture:[],image:[],sound:[],camera:[],entity:[],animation:[]};for(var e in t)Array.prototype.push.apply(t[e],["dropdown","select"]);return t}(),C={string:function(t,e){return"string"!=typeof e||0===e.length?{message:'Property "'+t+'" must be a non-empty string'}:void 0},number:function(t,e){return"number"!=typeof e?{message:'Property "'+t+'" must be a number'}:void 0},"boolean":function(t,e){return"boolean"!=typeof e?{message:'Property "'+t+'" must be a boolean'}:void 0},array:function(t,e){return e instanceof Array?void 0:{message:'Property "'+t+'" must be an array'}}},R=[{name:"key",validator:C.string},{name:"name",validator:C.string},{name:"control",validator:C.string},{name:"min",validator:C.number},{name:"max",validator:C.number},{name:"scale",validator:C.number},{name:"decimals",validator:C.number},{name:"precision",validator:C.number},{name:"exponential",validator:C["boolean"]}];return m.validateParameter=function(t){if("string"!=typeof t.key||0===t.key.length)return{message:'Property "key" must be a non-empty string'};for(var e=0;e<R.length;e++){var n=R[e];if("undefined"!=typeof t[n.name]){var o=n.validator(n.name,t[n.name]);if(o)return o}}if(-1===k.indexOf(t.type))return{message:'Property "type" must be one of: '+k.join(", ")};var i=E[t.type];return void 0!==t.control&&-1===i.indexOf(t.control)?{message:'Property "control" must be one of: '+i.join(", ")}:void 0},m.validateParameters=function(t,e){var n=t.errors||[];if("object"!=typeof t.externals)return void(e.externals={});var o=t.externals;if(!o.parameters||o.parameters instanceof Array||n.push("externals.parameters must be an array"),n.length)return void(e.errors=n);if(o.parameters){e.externals.parameters=[];for(var i=0;i<o.parameters.length;i++){var r=o.parameters[i],a=m.validateParameter(r);a&&n.push(a),(null===r["default"]||void 0===r["default"])&&(r["default"]=d.defaultsByType[r.type]),e.externals.parameters.push(r)}n.length&&(e.errors=n)}},m.DOM_ID_PREFIX="_script_",m}(goo.ConfigHandler,goo.rsvp,goo.OrbitCamControlScript,goo.OrbitNPanControlScript,goo.FlyControlScript,goo.WasdControlScript,goo.BasicControlScript,goo.PromiseUtils,goo.ObjectUtils,goo.ArrayUtils,goo.SystemBus,goo.ScriptUtils,goo.Scripts),goo.ScriptHandlers=function(){}(goo.ScriptHandler,goo.ScriptComponentHandler),goo.ScriptRegister=function(t){"use strict";for(var e=1;e<arguments.length;e++)t.register(arguments[e])}(goo.Scripts,goo.OrbitCamControlScript,goo.OrbitNPanControlScript,goo.FlyControlScript,goo.AxisAlignedCamControlScript,goo.PanCamScript,goo.MouseLookControlScript,goo.WasdControlScript,goo.ButtonScript,goo.PickAndRotateScript,goo.LensFlareScript),goo.SparseHeightMapBoundingScript=function(){"use strict";function t(t){this.elevationData=t}return t.prototype.getClosest=function(t,e){for(var n=Number.MAX_VALUE,o=-1,i=0;i<this.elevationData.length;i+=3){var r=Math.pow(this.elevationData[i+0]-t,2)+Math.pow(this.elevationData[i+2]-e,2);n>r&&(n=r,o=i)}return this.elevationData[o+1]},t.prototype.run=function(t){var e=t.transformComponent.transform.translation,n=this.getClosest(e.x,e.z),o=e.y-n;e.y-=.1*o},t}(),goo.WorldFittedTerrainScript=function(t,e){"use strict";function n(t,e){if(t.minX>t.maxX)throw new Error({name:"Terrain Exception",message:"minX is larger than maxX"});if(t.minY>t.maxY)throw new Error({name:"Terrain Exception",message:"minY is larger than maxY"});if(t.minZ>t.maxZ)throw new Error({name:"Terrain Exception",message:"minZ is larger than maxZ"});if(!e)throw new Error({name:"Terrain Exception",message:"No heightmap data specified"});if(e.length!==e[0].length)throw new Error({name:"Terrain Exception",message:"Heightmap data is not a square"});return!0}function o(e,o,i){o=o||s,n(o,e,i);var r={dimensions:o,sideQuadCount:e.length-1,script:new t(e)};return r}function i(){this.heightMapData=[],this.yMargin=1}var r=new e,a=new e,s={minX:0,maxX:100,minY:0,maxY:50,minZ:0,maxZ:100};return i.prototype.addHeightData=function(t,e){var n=o(t,e,this.heightMapData);return this.heightMapData.push(n),n},i.prototype.getHeightDataForPosition=function(t){for(var e=0;e<this.heightMapData.length;e++){var n=this.heightMapData[e].dimensions;if(t.x<=n.maxX&&t.x>=n.minX&&t.y<n.maxY+this.yMargin&&t.y>n.minY-this.yMargin&&t.z<=n.maxZ&&t.z>=n.minZ)return this.heightMapData[e]}return null},i.prototype.displaceAxisDimensions=function(t,e,n,o){var i=t-e;return o*i/(n-e)},i.prototype.returnToWorldDimensions=function(t,e,n,o){var i=(n-e)/o,r=t*i;return e+r},i.prototype.getTerrainHeightAt=function(t){var e=this.getHeightDataForPosition(t);if(null===e)return null;var n=e.dimensions,o=this.displaceAxisDimensions(t.x,n.minX,n.maxX,e.sideQuadCount),i=this.displaceAxisDimensions(t.z,n.minZ,n.maxZ,e.sideQuadCount),r=e.script.getPreciseHeight(o,i);return r*(n.maxY-n.minY)+n.minY},i.prototype.getTerrainNormalAt=function(t){var e=this.getHeightDataForPosition(t);if(!e)return null;for(var n=e.dimensions,o=this.displaceAxisDimensions(t.x,n.minX,n.maxX,e.sideQuadCount),i=this.displaceAxisDimensions(t.z,n.minZ,n.maxZ,e.sideQuadCount),s=e.script.getTriangleAt(o,i),c=0;c<s.length;c++)s[c].x=this.returnToWorldDimensions(s[c].x,n.minX,n.maxX,e.sideQuadCount),s[c].z=this.returnToWorldDimensions(s[c].z,n.minY,n.maxY,1),s[c].y=this.returnToWorldDimensions(s[c].y,n.minZ,n.maxZ,e.sideQuadCount);return r.setDirect(s[1].x-s[0].x,s[1].z-s[0].z,s[1].y-s[0].y),a.setDirect(s[2].x-s[0].x,s[2].z-s[0].z,s[2].y-s[0].y),r.cross(a),r.y<0&&r.scale(-1),r.normalize(),r},i}(goo.HeightMapBoundingScript,goo.Vector3),"function"==typeof require&&(define("goo/scriptpack/AxisAlignedCamControlScript",[],function(){return goo.AxisAlignedCamControlScript}),define("goo/scriptpack/BasicControlScript",[],function(){return goo.BasicControlScript}),define("goo/scriptpack/ButtonScript",[],function(){return goo.ButtonScript}),define("goo/scriptpack/CannonPickScript",[],function(){return goo.CannonPickScript}),define("goo/scriptpack/WasdControlScript",[],function(){return goo.WasdControlScript}),define("goo/scriptpack/MouseLookControlScript",[],function(){return goo.MouseLookControlScript}),define("goo/scriptpack/FlyControlScript",[],function(){return goo.FlyControlScript}),define("goo/scriptpack/GroundBoundMovementScript",[],function(){return goo.GroundBoundMovementScript}),define("goo/scriptpack/HeightMapBoundingScript",[],function(){return goo.HeightMapBoundingScript}),define("goo/scriptpack/LensFlareScript",[],function(){return goo.LensFlareScript}),define("goo/scriptpack/PanCamScript",[],function(){return goo.PanCamScript}),define("goo/scriptpack/OrbitNPanControlScript",[],function(){return goo.OrbitNPanControlScript}),define("goo/scriptpack/PickAndRotateScript",[],function(){return goo.PickAndRotateScript}),define("goo/scriptpack/PolyBoundingScript",[],function(){return goo.PolyBoundingScript}),define("goo/scriptpack/RotationScript",[],function(){return goo.RotationScript}),define("goo/scriptpack/ScriptComponentHandler",[],function(){return goo.ScriptComponentHandler}),define("goo/scriptpack/ScriptHandler",[],function(){return goo.ScriptHandler}),define("goo/scriptpack/ScriptHandlers",[],function(){return goo.ScriptHandlers}),define("goo/scriptpack/ScriptRegister",[],function(){return goo.ScriptRegister}),define("goo/scriptpack/SparseHeightMapBoundingScript",[],function(){return goo.SparseHeightMapBoundingScript}),define("goo/scriptpack/WorldFittedTerrainScript",[],function(){return goo.WorldFittedTerrainScript}));